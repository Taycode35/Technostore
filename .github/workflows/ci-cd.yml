name: CI/CD Pipeline TechnoStore

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop, main ]

  permissions:
    contents: read
    issues: write
    pull-requests: write
    checks: write

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  # ========================================
  # JOB 1 : Tests & Qualité de code (sur develop)
  # ========================================
  test-and-quality:
    name: Tests unitaires & Qualité du code
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || github.base_ref == 'develop'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configuration JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: Vérification des dépendances
        run: mvn dependency:resolve

      - name: Exécution des tests unitaires
        run: mvn clean test -Dspring.profiles.active=test

      - name: Génération du rapport de couverture
        run: mvn jacoco:report
        continue-on-error: true

      - name: Publication des résultats des tests
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Tests JUnit
          path: target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: true

      - name: Analyse de la qualité du code
        run: mvn verify
        continue-on-error: true

      - name: Commentaire sur la PR (si échec)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Les tests unitaires ont échoué. Veuillez corriger les erreurs avant de merger.'
            })

  # ========================================
  # JOB 2 : Protection de la branche main
  # ========================================
  check-branch-protection:
    name: Vérification des droits de merge vers main
    runs-on: ubuntu-latest
    if: github.base_ref == 'main'

    steps:
      - name: Vérifier que la PR vient de develop
        run: |
          if [ "${{ github.head_ref }}" != "develop" ]; then
            echo "ERREUR: Seule la branche 'develop' peut créer une PR vers 'main'"
            echo "Branche source détectée: ${{ github.head_ref }}"
            exit 1
          else
            echo "Branche source autorisée: develop"
          fi

  # ========================================
  # JOB 3 : Build & Tests (avant déploiement)
  # ========================================
  build:
    name: Build de l'application
    runs-on: ubuntu-latest
    needs: check-branch-protection
    if: |
      (github.event_name == 'pull_request' && github.base_ref == 'main') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configuration JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: Tests unitaires (vérification finale)
        run: mvn clean test -Dspring.profiles.active=test

      - name: Build du JAR
        run: mvn clean package -DskipTests

      - name: Upload de l'artifact
        uses: actions/upload-artifact@v4
        with:
          name: technostore-jar
          path: target/*.jar
          retention-days: 7

  # ========================================
  # JOB 4 : Déploiement sur Railway (prod)
  # ========================================
  deploy:
    name: Déploiement sur Railway
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://technostore.up.railway.app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Téléchargement de l'artifact
        uses: actions/download-artifact@v4
        with:
          name: technostore-jar
          path: target/

      - name: Configuration JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      # Build du jar avec le profil prod
      - name: Build du JAR pour production
        run: mvn clean package -DskipTests -Dspring.profiles.active=prod

      - name: Installation de Railway CLI
        run: npm install -g @railway/cli

      - name: Déploiement sur Railway
        run: railway up --service technostore --build --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          SPRING_PROFILES_ACTIVE: prod

      - name: Notification de succès
        if: success()
        run: |
          echo "Déploiement réussi sur Railway"
          echo "Application disponible sur : https://technostore.up.railway.app"

      - name: Notification d'échec
        if: failure()
        run: |
          echo "Échec du déploiement sur Railway"
          echo "Consultez les logs pour plus de détails"