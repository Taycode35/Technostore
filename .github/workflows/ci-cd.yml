name: CI/CD Pipeline TechnoStore

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop, main ]


env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  # ========================================

  # JOB 1 : Tests & Qualite de code (sur develop)
  # ========================================
  test-and-quality:
    name: Tests unitaires et qualite du code
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || github.base_ref == 'develop'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configuration JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: Verification des dependances
        run: mvn dependency:resolve

      - name: Execution des tests unitaires
        run: mvn clean test -Dspring.profiles.active=test

      - name: Affichage du resume des tests
        if: always()
        run: |
          echo "Resume des tests :"
          if [ -f target/surefire-reports/TEST-*.xml ]; then
            echo "Rapports de tests generes"
            grep -r "tests=" target/surefire-reports/*.xml | head -1 || echo "Analyse en cours..."
          else
            echo "Aucun rapport de test trouve"
          fi

      - name: Analyse de la qualite du code
        run: mvn verify
        continue-on-error: true

  # ========================================
  # JOB 2 : Protection de la branche main
  # ========================================
  check-branch-protection:
    name: Vérification des droits de merge vers main
    runs-on: ubuntu-latest
    if: github.base_ref == 'main'

    steps:
      - name: Vérifier que la PR vient de develop
        run: |
          if [ "${{ github.head_ref }}" != "develop" ]; then
            echo "ERREUR: Seule la branche 'develop' peut créer une PR vers 'main'"
            echo "Branche source détectée: ${{ github.head_ref }}"
            exit 1
          else
            echo "Branche source autorisée: develop"
          fi

  # ========================================
  # JOB 3 : Build & Tests (avant déploiement)
  # ========================================
  build:
    name: Build de l'application
    runs-on: ubuntu-latest
    needs: check-branch-protection
    if: |
      (github.event_name == 'pull_request' && github.base_ref == 'main') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configuration JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: Tests unitaires (vérification finale)
        run: mvn clean test -Dspring.profiles.active=test

      - name: Build du JAR
        run: mvn clean package -DskipTests

      - name: Upload de l'artifact
        uses: actions/upload-artifact@v4
        with:
          name: technostore-jar
          path: target/*.jar
          retention-days: 7

  # ========================================
  # JOB 4 : Déploiement sur Railway (prod)
  # ========================================
  deploy:
    name: Déploiement sur Railway
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://technostore.up.railway.app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Téléchargement de l'artifact
        uses: actions/download-artifact@v4
        with:
          name: technostore-jar
          path: target/

      - name: Configuration JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      # Build du jar avec le profil prod
      - name: Build du JAR pour production
        run: mvn clean package -DskipTests -Dspring.profiles.active=prod

      - name: Installation de Railway CLI
        run: npm install -g @railway/cli

      - name: Déploiement sur Railway
        run: railway up --service technostore --build --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          SPRING_PROFILES_ACTIVE: prod

      - name: Notification de succès
        if: success()
        run: |
          echo "Déploiement réussi sur Railway"
          echo "Application disponible sur : https://technostore.up.railway.app"

      - name: Notification d'échec
        if: failure()
        run: |
          echo "Échec du déploiement sur Railway"
          echo "Consultez les logs pour plus de détails"